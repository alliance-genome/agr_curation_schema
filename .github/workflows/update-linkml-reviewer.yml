name: Update LinkML Reviewer Reference Files

# Trigger on pushes to main that touch schema-relevant files, or manually
on:
  push:
    branches: [main]
    paths:
      - 'model/schema/**'    # Schema files - classes, slots, enums, inheritance
      - 'Makefile'           # Build flags (--closed, -t Ingest) - ENFORCED rules depend on this
      - 'pyproject.toml'     # LinkML version - affects available features/constraints
      - 'test/data/**'       # Test files - new tests signal new conventions or entities
      - 'README.md'          # Documents conventions (DTO divergence, dual-ID rule, etc.)
  workflow_dispatch:          # Manual trigger for catching up on missed updates

jobs:
  update-linkml-reviewer:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1. Checkout the triggering repo (agr_curation_schema)
      - name: Checkout agr_curation_schema
        uses: actions/checkout@v6
        with:
          fetch-depth: 2     # Need previous commit for diff

      # 2. Checkout the target repo (agr_claude_code)
      - name: Checkout agr_claude_code
        uses: actions/checkout@v6
        with:
          repository: alliance-genome/agr_claude_code
          path: agr_claude_code
          token: ${{ secrets.AGR_CLAUDE_CODE_PAT }}

      # 3. Generate reference files from current schema
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate reference files
        run: |
          python agr_claude_code/scripts/update-schema-inventory.py \
            model/schema/ \
            /tmp/generated-refs/

      # 4. Install Claude Code CLI and run the update agent
      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Compare and update reference files
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.AGR_CLAUDE_CODE_PAT }}
        run: |
          claude -p "$(cat <<'PROMPT'
          You are an automated agent maintaining LinkML reviewer reference files
          for the Alliance of Genome Resources.

          ## Context

          The agr_curation_schema repository contains LinkML schema definitions.
          The agr_claude_code repository contains a LinkML reviewer skill that
          helps developers review schema changes. When the schema changes, the
          reviewer's reference files must be updated to stay current.

          ## File Locations

          - Schema source: ./model/schema/ (current directory is agr_curation_schema)
          - Generated reference files: /tmp/generated-refs/ (already generated by a Python script)
          - Current reference files: ./agr_claude_code/plugins/linkml-reviewer/skills/linkml-review/reference/
          - Plugin version file: ./agr_claude_code/plugins/linkml-reviewer/.claude-plugin/plugin.json
          - Marketplace version file: ./agr_claude_code/.claude-plugin/marketplace.json

          ## Your Task

          ### Step 1: Understand what changed in the schema

          Run: git diff HEAD~1 -- model/schema/ Makefile pyproject.toml test/data/ README.md

          If the diff is empty (e.g., manual trigger via workflow_dispatch), note
          "Manual trigger — no incremental diff available" and proceed to Step 2.

          Summarize the changes — what classes, slots, enums, or relationships were
          added, removed, or modified?

          ### Step 2: Compare generated vs current reference files

          Compare each pair using diff:
          - diff ./agr_claude_code/plugins/linkml-reviewer/skills/linkml-review/reference/schema-inventory.md /tmp/generated-refs/schema-inventory.md
          - diff ./agr_claude_code/plugins/linkml-reviewer/skills/linkml-review/reference/inheritance-tree.md /tmp/generated-refs/inheritance-tree.md
          - diff ./agr_claude_code/plugins/linkml-reviewer/skills/linkml-review/reference/import-graph.md /tmp/generated-refs/import-graph.md
          - diff ./agr_claude_code/plugins/linkml-reviewer/skills/linkml-review/reference/dto-suffix-reference.md /tmp/generated-refs/dto-suffix-reference.md

          ### Step 3: Decide and act

          If NO reference files have meaningful differences (ignoring whitespace),
          print "No reference file updates needed" and exit.

          If ANY reference file has meaningful differences:

          1. Copy the generated files over the current ones:
             cp /tmp/generated-refs/*.md ./agr_claude_code/plugins/linkml-reviewer/skills/linkml-review/reference/

          2. Increment the PATCH version number in TWO files:
             - ./agr_claude_code/plugins/linkml-reviewer/.claude-plugin/plugin.json
               (the top-level "version" field, e.g. "1.0.0" -> "1.0.1")
             - ./agr_claude_code/.claude-plugin/marketplace.json
               (the "version" field inside the "linkml-reviewer" entry only)

          3. Create a branch, commit, push, and open a PR:
             cd agr_claude_code
             git checkout -b update-linkml-refs-$(date +%Y%m%d-%H%M%S)
             git add plugins/linkml-reviewer/skills/linkml-review/reference/
             git add plugins/linkml-reviewer/.claude-plugin/plugin.json
             git add .claude-plugin/marketplace.json
             git commit -m "Update LinkML reviewer reference files and bump version"
             git push -u origin HEAD

             Then open a PR with gh cli. Include:
             - A title like "Update LinkML reviewer reference files (v<NEW_VERSION>)"
             - A body with: schema change summary, which reference files changed,
               the version bump, and a link to the triggering commit
             - Reviewer: christabone

             gh pr create \
               --repo alliance-genome/agr_claude_code \
               --reviewer christabone \
               --title "Update LinkML reviewer reference files (v<NEW_VERSION>)" \
               --body "<your summary>"

          ## Important Rules

          - Do NOT modify the generated reference files. Copy them as-is.
          - Do NOT edit the schema files or review code quality.
          - The GH_TOKEN environment variable is already set for gh cli and git push.
          - The agr_claude_code repo is at ./agr_claude_code/ (git credentials pre-configured).
          PROMPT
          )" \
            --model "${{ vars.CLAUDE_PR_REVIEW_MODEL }}" \
            --max-turns 60 \
            --allowedTools "Bash,Read,Write,Edit,Glob,Grep,LS"
